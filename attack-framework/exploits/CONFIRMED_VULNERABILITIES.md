# Confirmed Vulnerabilities

This document lists vulnerabilities that have been **confirmed through code review** (not just hypothesized).

## Confirmation Method

Each vulnerability was confirmed by:
1. Reading the actual Rust source code
2. Identifying specific lines/functions that lack protection
3. Documenting the exact attack flow

## IDL Protocol (BSn7neicVV2kEzgaZmd6tZEBm4tdgzBRyELov65Lq7dt)

### 1. REFERRAL_LOOP (HIGH) ✅ CONFIRMED

**Location:** `programs/idl-protocol/src/lib.rs` lines 2326-2343

**Issue:** No check preventing self-referral

**Code:**
```rust
#[derive(Accounts)]
pub struct RegisterReferral<'info> {
    #[account(
        init,
        payer = user,
        space = 8 + ReferralAccount::INIT_SPACE,
        seeds = [b"referral", user.key().as_ref()],
        bump
    )]
    pub referral_account: Account<'info, ReferralAccount>,

    /// CHECK: Referrer just needs to be a valid pubkey
    pub referrer: AccountInfo<'info>,  // <-- NO constraint: referrer != user

    #[account(mut)]
    pub user: Signer<'info>,
    // ...
}
```

**Attack:**
1. User A calls `register_referral` with `referrer = A.pubkey`
2. User A bets, pays 3% fee
3. 5% of fees (0.15% of bet) goes to User A forever
4. Effectively a 0.15% fee rebate

**Impact:** Users can reduce their effective fees by ~5%

**Fix:**
```rust
constraint = referrer.key() != user.key() @ IdlError::SelfReferralNotAllowed
```

---

### 2. CONVICTION BONUS NOT IMPLEMENTED (HIGH) ✅ CONFIRMED BUG

**Location:** `programs/idl-protocol/src/lib.rs`

**Issue:** `place_conviction_bet` creates a ConvictionBet with `bonus_bps`, but `claim_winnings` never reads or applies it.

**Evidence:**
- `place_conviction_bet` (line 1422-1451): Creates ConvictionBet with bonus_bps
- `claim_winnings` (line 519-617): Uses only `bet.effective_amount`, never references ConvictionBet
- No instruction to claim conviction bonus exists

**Impact:**
- Conviction betting feature is **completely broken**
- Users who lock bets for 30 days expecting 15% bonus get **nothing**
- This is a missing feature, not an exploitable vulnerability

**Fix:** Implement conviction bonus application in `claim_winnings` or create separate claim instruction.

---

## IDL Stableswap (EFsgmpbKifyA75ZY5NPHQxrtuAHHB6sYnoGkLi6xoTte)

### 3. ZERO_SLIPPAGE_EXPLOIT (MEDIUM) ✅ CONFIRMED

**Location:** `programs/idl-stableswap/src/lib.rs` - all swap functions

**Issue:** `min_amount_out` is user-provided with no minimum enforcement

**Code:**
```rust
pub fn migrate_bags_to_pump(
    ctx: Context<Swap>,
    amount_in: u64,
    min_amount_out: u64,  // <-- User can set to 0
    deadline: i64,
) -> Result<()> {
    // ...
    require!(amount_out >= min_amount_out, StableSwapError::SlippageExceeded);
    // If min_amount_out = 0, any output is accepted
}
```

**Attack:**
1. User submits swap with `min_amount_out = 0`
2. MEV bot front-runs, manipulates price
3. User gets almost nothing, MEV bot profits

**Affected Functions:**
- `migrate_bags_to_pump` (line 534)
- `migrate_pump_to_bags` (line 625)
- `swap_bags_to_pump` (line 961)
- `swap_pump_to_bags` (line 1061)
- `add_liquidity` (line 145)
- `add_liquidity_single_sided` (line 420)
- `remove_liquidity` (line 317)

**Impact:** Users who set 0 slippage can lose 100% to MEV

**Fix:**
```rust
// Enforce maximum slippage (e.g., 5%)
require!(
    amount_out * 100 >= amount_in * 95,
    StableSwapError::SlippageTooHigh
);
```

---

### 4. SLIPPAGE_SANDWICH (HIGH) ✅ CONFIRMED

**Location:** `programs/idl-stableswap/src/lib.rs` - all swap functions

**Issue:** No commit-reveal mechanism, all swaps visible in mempool

**Evidence:**
- No `commit_swap` / `reveal_swap` instructions exist
- All swap parameters visible before execution
- Standard MEV sandwich attack surface

**Attack:**
1. Victim submits swap with reasonable slippage (e.g., 2%)
2. MEV bot front-runs with large swap
3. Victim's swap executes at worst allowed price
4. MEV bot back-runs, profits from price difference

**Impact:** MEV bots can extract up to `slippage_tolerance` from every swap

**Fix:** Add commit-reveal for swaps > threshold, or use private mempool.

---

### 5. LP_SANDWICH (MEDIUM) ✅ CONFIRMED

**Location:** `programs/idl-stableswap/src/lib.rs` - liquidity functions

**Issue:** No commit-reveal for add/remove liquidity

**Affected Functions:**
- `add_liquidity` (line 145)
- `add_liquidity_single_sided` (line 420)
- `remove_liquidity` (line 317)

**Impact:** MEV bots can sandwich LP additions for profit

---

## Previously Claimed Vulnerabilities - NOT CONFIRMED

### CONVICTION_CANCEL - NOT EXPLOITABLE

**Original Claim:** User locks bet for bonus, market cancels, free bonus

**Reality:** Since conviction bonus is never applied (see Bug #2), there's nothing to exploit.

---

## Summary

| Vulnerability | Severity | Status | Target |
|--------------|----------|--------|--------|
| REFERRAL_LOOP | HIGH | CONFIRMED | idl-protocol |
| CONVICTION_BONUS_BUG | HIGH | CONFIRMED (BUG) | idl-protocol |
| ZERO_SLIPPAGE_EXPLOIT | MEDIUM | CONFIRMED | idl-stableswap |
| SLIPPAGE_SANDWICH | HIGH | CONFIRMED | idl-stableswap |
| LP_SANDWICH | MEDIUM | CONFIRMED | idl-stableswap |

**Total Confirmed Issues: 5** (4 vulnerabilities + 1 missing feature bug)

## Not Tested (Would Require On-Chain Execution)

The following attacks from my hypothetical list would require actual on-chain testing with funded accounts:
- PAUSE_FRONT_RUN
- RESOLUTION_STALL
- ORACLE_EXHAUSTION
- And ~35 others

These remain **hypothetical** until tested with real transactions.
