<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDL Registry - Status</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="stylesheet" href="/src/theme.css">
    <style>
        /* Page-specific styles - global theme loaded from /src/theme.css */

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            border-left: 1px solid var(--border-secondary);
            border-right: 1px solid var(--border-secondary);
        }

        .header {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 16px 24px;
            border-bottom: 2px solid var(--border-primary);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header h1 {
            font-size: 16px;
            margin: 0;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }

        .header h1::before {
            content: '> ';
            color: var(--accent-primary);
        }

        .header p {
            font-size: 12px;
            color: var(--text-secondary);
            margin: 4px 0 0 0;
        }

        .nav-links {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .nav-link {
            padding: 4px 12px;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid var(--border-secondary);
            background: var(--bg-secondary);
        }

        .nav-link:hover {
            background: var(--accent-hover);
            color: var(--bg-secondary);
        }

        .nav-link.active {
            background: var(--accent-primary);
            color: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        .stats {
            display: flex;
            gap: 32px;
            padding: 12px 0 0 0;
            font-size: 11px;
        }

        .stat {
            display: flex;
            align-items: baseline;
            gap: 6px;
        }

        .stat::before {
            content: '|';
            color: var(--border-secondary);
            margin-right: 6px;
        }

        .stat:first-child::before {
            content: '';
            margin-right: 0;
        }

        .stat-number {
            font-size: 14px;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid;
        }

        .status-badge.operational {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border-color: #22c55e;
        }

        .status-badge.degraded {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border-color: #f59e0b;
        }

        .status-badge.down {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: #ef4444;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .summary-section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-secondary);
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            padding: 12px 16px;
        }

        .summary-card h3 {
            font-size: 10px;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 0 0 4px 0;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .summary-card .subtitle {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-secondary);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .section-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-primary);
        }

        .section-title::before {
            content: '// ';
            color: var(--text-muted);
        }

        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 4px 10px;
            font-size: 10px;
            border: 1px solid var(--border-secondary);
            background: var(--bg-secondary);
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            font-weight: 600;
            text-transform: uppercase;
            font-family: inherit;
        }

        .filter-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }

        .filter-btn.active {
            background: var(--accent-primary);
            color: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        .uptime-chart {
            background: var(--bg-tertiary);
            padding: 12px;
            border: 1px solid var(--border-secondary);
        }

        .uptime-bars {
            display: flex;
            gap: 2px;
            height: 40px;
            align-items: flex-end;
        }

        .uptime-bar {
            flex: 1;
            min-width: 3px;
            transition: all 0.2s;
            cursor: pointer;
        }

        .uptime-bar:hover {
            opacity: 0.8;
        }

        .uptime-bar.ok { background: #22c55e; }
        .uptime-bar.warn { background: #f59e0b; }
        .uptime-bar.error { background: #ef4444; }
        .uptime-bar.unknown { background: var(--text-muted); }

        .uptime-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 9px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .protocols-list {
            max-height: 500px;
            overflow-y: auto;
        }

        .protocol-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-secondary);
        }

        .protocol-item:last-child {
            border-bottom: none;
        }

        .protocol-status {
            width: 10px;
            height: 10px;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .protocol-status.verified { background: #22c55e; }
        .protocol-status.partial { background: #3b82f6; }
        .protocol-status.devnet_only { background: #8b5cf6; }
        .protocol-status.placeholder { background: var(--text-muted); }
        .protocol-status.no_program_id { background: #f59e0b; }
        .protocol-status.program_not_found { background: #ef4444; }
        .protocol-status.rpc_error { background: #ef4444; }

        .protocol-info {
            flex: 1;
            min-width: 0;
        }

        .protocol-name {
            font-size: 13px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .protocol-meta {
            font-size: 10px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .protocol-badge {
            padding: 2px 8px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            border: 1px solid;
        }

        .protocol-badge.verified {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border-color: #22c55e;
        }

        .protocol-badge.partial {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
            border-color: #3b82f6;
        }

        .protocol-badge.devnet_only {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            border-color: #8b5cf6;
        }

        .protocol-badge.placeholder {
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border-color: var(--border-secondary);
        }

        .protocol-badge.no_program_id,
        .protocol-badge.program_not_found,
        .protocol-badge.rpc_error {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: #ef4444;
        }

        .info-section {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            align-items: center;
            font-size: 11px;
        }

        .info-item {
            color: var(--text-secondary);
        }

        .info-item strong {
            color: var(--text-primary);
        }

        .refresh-btn {
            padding: 6px 12px;
            background: var(--accent-primary);
            color: var(--bg-secondary);
            border: none;
            cursor: pointer;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            font-family: inherit;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: var(--accent-hover);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .footer {
            padding: 16px 24px;
            background: var(--bg-secondary);
            border-top: 2px solid var(--border-primary);
            text-align: center;
            color: var(--text-secondary);
            font-size: 10px;
        }

        .footer a {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 600;
        }

        .footer a::before {
            content: '[';
            color: var(--border-primary);
        }

        .footer a::after {
            content: ']';
            color: var(--border-primary);
        }

        .footer a:hover {
            text-decoration: underline;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 11px;
            text-transform: uppercase;
        }

        .no-results {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 14px;
            }

            .stats {
                flex-direction: column;
                gap: 8px;
            }

            .summary-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .nav-links {
                flex-wrap: wrap;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <div>
                        <h1>idlhub.com</h1>
                        <p>Verification Status</p>
                    </div>
                </div>
                <div class="header-actions">
                    <nav class="nav-links">
                        <a href="/app/registry" class="nav-link">Registry</a>
                        <a href="/app/" class="nav-link">Protocol</a>
                        <a href="/app/status" class="nav-link active">Status</a>
                        <a href="/docs" class="nav-link">Docs</a>
                    </nav>
                    <div id="overall-status" class="status-badge operational">
                        <span class="status-dot"></span>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="verified-count">-</div>
                    <div class="stat-label">Verified</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="total-count">-</div>
                    <div class="stat-label">Protocols</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="programs-count">-</div>
                    <div class="stat-label">Programs</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="last-run">-</div>
                    <div class="stat-label">Last Check</div>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <div class="summary-grid">
                <div class="summary-card">
                    <h3>Verified</h3>
                    <div class="value" id="summary-verified">-</div>
                    <div class="subtitle" id="verified-percent">-</div>
                </div>
                <div class="summary-card">
                    <h3>Partial</h3>
                    <div class="value" id="partial-count">-</div>
                    <div class="subtitle">Some programs</div>
                </div>
                <div class="summary-card">
                    <h3>Devnet Only</h3>
                    <div class="value" id="devnet-count">-</div>
                    <div class="subtitle">Not on mainnet</div>
                </div>
                <div class="summary-card">
                    <h3>Issues</h3>
                    <div class="value" id="issues-count">-</div>
                    <div class="subtitle">Need attention</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <span class="section-title">Verification History (24h)</span>
            </div>
            <div class="uptime-chart">
                <div class="uptime-bars" id="uptime-bars">
                    <div class="loading">Loading history...</div>
                </div>
                <div class="uptime-labels">
                    <span>24 hours ago</span>
                    <span>Now</span>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-header">
                <span class="section-title">Protocol Status</span>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="verified">Verified</button>
                    <button class="filter-btn" data-filter="partial">Partial</button>
                    <button class="filter-btn" data-filter="devnet">Devnet</button>
                    <button class="filter-btn" data-filter="issues">Issues</button>
                </div>
            </div>
            <div class="protocols-list" id="protocols-list">
                <div class="loading">Loading protocols...</div>
            </div>
        </div>

        <div class="section">
            <div class="info-section">
                <div class="info-item">Scheduler: <strong id="scheduler-status">-</strong></div>
                <div class="info-item">Next run: <strong id="next-run">-</strong></div>
                <div class="info-item">Interval: <strong id="interval">-</strong></div>
                <button class="refresh-btn" id="refresh-btn" onclick="triggerVerification()">Run Verification</button>
            </div>
        </div>

        <div class="footer">
            <p>idlhub.com - Open source IDL registry for the Solana ecosystem</p>
            <p style="margin-top: 8px;">
                <a href="https://github.com/openSVM/idlhub">GitHub</a>
                <a href="/docs">Documentation</a>
                <a href="/api/status">API</a>
            </p>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentFilter = 'all';
        let protocolsData = {};

        async function fetchStatus() {
            try {
                const response = await fetch(`${API_BASE}/status`);
                const data = await response.json();
                updateStatus(data);
            } catch (err) {
                console.error('Failed to fetch status:', err);
                document.getElementById('overall-status').innerHTML = `
                    <span class="status-dot"></span>
                    <span>Error</span>
                `;
                document.getElementById('overall-status').className = 'status-badge down';
            }
        }

        async function fetchProtocols() {
            try {
                const response = await fetch(`${API_BASE}/status/protocols`);
                const data = await response.json();
                protocolsData = data.protocols || {};
                renderProtocols();
            } catch (err) {
                console.error('Failed to fetch protocols:', err);
                document.getElementById('protocols-list').innerHTML = `<div class="no-results">Failed to load protocols</div>`;
            }
        }

        function updateStatus(data) {
            const statusBadge = document.getElementById('overall-status');
            const status = data.status || 'operational';
            statusBadge.className = `status-badge ${status}`;
            statusBadge.innerHTML = `<span class="status-dot"></span><span>${status.charAt(0).toUpperCase() + status.slice(1)}</span>`;

            const stats = data.stats || {};
            document.getElementById('verified-count').textContent = stats.availableProtocols || 0;
            document.getElementById('total-count').textContent = stats.totalProtocols || 0;
            document.getElementById('summary-verified').textContent = stats.availableProtocols || 0;

            const v = data.verification || {};
            document.getElementById('verified-percent').textContent = v.verifiedPercent ? `${v.verifiedPercent}%` : '-';
            document.getElementById('partial-count').textContent = v.partial || 0;
            document.getElementById('devnet-count').textContent = v.devnetOnly || 0;
            document.getElementById('programs-count').textContent = v.verifiedPrograms ? `${v.verifiedPrograms}/${v.totalPrograms || 0}` : '-';
            document.getElementById('issues-count').textContent = (v.issues || 0);

            if (v.lastRun) {
                const lastRunDate = new Date(v.lastRun);
                const diffMins = Math.floor((new Date() - lastRunDate) / 60000);
                document.getElementById('last-run').textContent = diffMins < 60 ? `${diffMins}m ago` : `${Math.floor(diffMins / 60)}h ago`;
            }

            const scheduler = v.scheduler || {};
            document.getElementById('scheduler-status').textContent = scheduler.running ? 'Running' : 'Stopped';
            document.getElementById('interval').textContent = scheduler.intervalHuman || '1 hour';
            if (scheduler.nextRun) {
                document.getElementById('next-run').textContent = new Date(scheduler.nextRun).toLocaleTimeString();
            }

            renderUptimeChart(data.history || []);
        }

        function renderUptimeChart(history) {
            const container = document.getElementById('uptime-bars');

            const bars = [];
            for (let i = 0; i < 24; i++) {
                const entry = history[23 - i];
                if (entry) {
                    const percent = (entry.verified / entry.total) * 100;
                    let status = 'ok';
                    if (percent < 50) status = 'error';
                    else if (percent < 80) status = 'warn';
                    bars.push(`<div class="uptime-bar ${status}" style="height: ${Math.max(10, percent)}%" title="${entry.verified}/${entry.total} verified"></div>`);
                } else {
                    bars.push(`<div class="uptime-bar unknown" style="height: 10%" title="No data"></div>`);
                }
            }
            container.innerHTML = bars.join('');
        }

        function renderProtocols() {
            const container = document.getElementById('protocols-list');
            const protocols = Object.values(protocolsData);

            if (!protocols.length) {
                container.innerHTML = '<div class="no-results">No verification data available on static hosting</div>';
                return;
            }

            let filtered = protocols;
            if (currentFilter === 'verified') filtered = protocols.filter(p => p.status === 'verified');
            else if (currentFilter === 'partial') filtered = protocols.filter(p => p.status === 'partial');
            else if (currentFilter === 'devnet') filtered = protocols.filter(p => p.status === 'devnet_only');
            else if (currentFilter === 'issues') filtered = protocols.filter(p => ['program_not_found', 'rpc_error', 'no_program_id'].includes(p.status));

            const statusOrder = { rpc_error: 0, program_not_found: 1, no_program_id: 2, partial: 3, devnet_only: 4, verified: 5, placeholder: 6 };
            filtered.sort((a, b) => (statusOrder[a.status] || 9) - (statusOrder[b.status] || 9));

            const rows = filtered.map(p => {
                const programs = p.programs || [];
                const verifiedCount = programs.filter(prog => prog.status === 'verified').length;
                const hasPrograms = programs.length > 0;

                return `
                    <div class="protocol-item">
                        <div class="protocol-status ${p.status}"></div>
                        <div class="protocol-info">
                            <div class="protocol-name">${p.protocolName || p.protocolId}</div>
                            <div class="protocol-meta">${p.protocolId}${hasPrograms ? ` â€¢ ${verifiedCount}/${programs.length} programs` : ''}</div>
                        </div>
                        <span class="protocol-badge ${p.status}">${(p.status || 'unknown').replace(/_/g, ' ')}</span>
                    </div>
                `;
            }).join('');

            container.innerHTML = rows || '<div class="no-results">No protocols match filter</div>';
        }

        async function triggerVerification() {
            const btn = document.getElementById('refresh-btn');
            btn.disabled = true;
            btn.textContent = 'Running...';

            try {
                const response = await fetch(`${API_BASE}/status/verify`, { method: 'POST' });
                await response.json();
                await fetchStatus();
                await fetchProtocols();
            } catch (err) {
                console.error('Verification failed:', err);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Run Verification';
            }
        }

        document.querySelectorAll('.filter-btn').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                currentFilter = tab.dataset.filter;
                renderProtocols();
            });
        });

        fetchStatus();
        fetchProtocols();
    </script>
</body>

</html>
